{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header">
                    <h2 class="text-center">Create New Workout</h2>
                </div>
                <div class="card-body">
                    <form method="post" id="workout-form">
                        {% csrf_token %}

                        <!-- Workout Date -->
                        <div class="mb-3">
                            <label for="id_date" class="form-label">Workout Date</label>
                            {{ workout_form.date }}
                            {% if workout_form.date.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in workout_form.date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Exercises -->
                        <h4 class="mb-3">Exercises</h4>
                        <div class="table-responsive">
                            <table class="table">
                                {{ rep_formset.management_form }}
                                {{ timed_formset.management_form }}
                                <tbody id="exercise-forms">
                                    <!-- Rep-based exercises -->
                                    {% for form in rep_formset %}
                                        <tr class="exercise-form rep-based-form">
                                            <td>
                                                <label for="{{ form.name.id_for_label }}" class="form-label">Exercise Name</label>
                                                {{ form.name }}
                                                {% if form.name.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.name.errors }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="rep-based-field">
                                                <label for="{{ form.sets.id_for_label }}" class="form-label">Sets</label>
                                                {{ form.sets }}
                                                {% if form.sets.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.sets.errors }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="rep-based-field">
                                                <label for="{{ form.reps.id_for_label }}" class="form-label">Reps</label>
                                                {{ form.reps }}
                                                {% if form.reps.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.reps.errors }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <label for="{{ form.weight.id_for_label }}" class="form-label">lbs (opt.)</label>
                                                {{ form.weight }}
                                                {% if form.weight.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.weight.errors }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-link text-danger delete-exercise" title="Delete exercise" style="position: relative; top: 1.5rem;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    
                                    <!-- Timed exercises -->
                                    {% for form in timed_formset %}
                                        <tr class="exercise-form timed-form">
                                            <td>
                                                <label for="{{ form.name.id_for_label }}" class="form-label">Exercise Name</label>
                                                {{ form.name }}
                                                {% if form.name.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.name.errors }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="timed-field" colspan="2">
                                                <div class="row">
                                                    <div class="col">
                                                        <label for="{{ form.duration_minutes.id_for_label }}" class="form-label">Minutes</label>
                                                        {{ form.duration_minutes }}
                                                        {% if form.duration_minutes.errors %}
                                                            <div class="invalid-feedback d-block">{{ form.duration_minutes.errors }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col">
                                                        <label for="{{ form.duration_seconds.id_for_label }}" class="form-label">Seconds</label>
                                                        {{ form.duration_seconds }}
                                                        {% if form.duration_seconds.errors %}
                                                            <div class="invalid-feedback d-block">{{ form.duration_seconds.errors }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <label for="{{ form.weight.id_for_label }}" class="form-label">lbs (opt.)</label>
                                                {{ form.weight }}
                                                {% if form.weight.errors %}
                                                    <div class="invalid-feedback d-block">{{ form.weight.errors }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-link text-danger delete-exercise" title="Delete exercise" style="position: relative; top: 1.5rem;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="d-grid gap-2 mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-primary w-100" id="add-rep-based-exercise">
                                        <i class="fas fa-plus"></i> Add Rep-Based Exercise
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-primary w-100" id="add-timed-exercise">
                                        <i class="fas fa-plus"></i> Add Timed Exercise
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary" id="submit-workout">Save Workout</button>
                            <a href="{% url 'workouts:workout_list' %}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addRepBasedButton = document.getElementById('add-rep-based-exercise');
    const addTimedButton = document.getElementById('add-timed-exercise');
    const repTotalForms = document.getElementById('id_rep-TOTAL_FORMS');
    const timedTotalForms = document.getElementById('id_timed-TOTAL_FORMS');
    const exerciseForms = document.getElementById('exercise-forms');
    
    // Get empty form templates
    const emptyRepForm = document.querySelector('.rep-based-form')?.cloneNode(true);
    const emptyTimedForm = document.querySelector('.timed-form')?.cloneNode(true);
    
    // Clear templates
    [emptyRepForm, emptyTimedForm].forEach(template => {
        if (template) {
            template.querySelectorAll('input').forEach(input => {
                input.value = '';
                input.checked = false;
            });
        }
    });

    function updateFormIndices(prefix) {
        const forms = document.querySelectorAll(`.${prefix}-form`);
        const totalForms = prefix === 'rep-based' ? repTotalForms : timedTotalForms;
        
        forms.forEach((form, index) => {
            form.querySelectorAll('input, select').forEach(input => {
                if (input.name) {
                    input.name = input.name.replace(/-\d+-/, `-${index}-`);
                    input.id = input.id.replace(/-\d+-/, `-${index}-`);
                }
            });
        });
        
        totalForms.value = forms.length;
    }

    function addExerciseForm(type) {
        const template = type === 'rep-based' ? emptyRepForm : emptyTimedForm;
        if (!template) return;

        const newForm = template.cloneNode(true);
        const formCount = document.querySelectorAll(`.${type}-form`).length;
        const prefix = type === 'rep-based' ? 'rep' : 'timed';

        // Update form indices
        newForm.querySelectorAll('input, select').forEach(input => {
            if (input.name) {
                input.name = input.name.replace(/-\d+-/, `-${formCount}-`);
                input.id = input.id.replace(/-\d+-/, `-${formCount}-`);
            }
        });

        exerciseForms.appendChild(newForm);
        
        // Update total forms count
        const totalForms = type === 'rep-based' ? repTotalForms : timedTotalForms;
        totalForms.value = parseInt(totalForms.value) + 1;

        // Focus on name field
        const nameInput = newForm.querySelector('input[name$="-name"]');
        if (nameInput) {
            nameInput.focus();
        }
    }

    // Add exercise buttons
    addRepBasedButton.addEventListener('click', () => addExerciseForm('rep-based'));
    addTimedButton.addEventListener('click', () => addExerciseForm('timed'));

    // Delete exercise
    exerciseForms.addEventListener('click', function(e) {
        if (e.target.closest('.delete-exercise')) {
            const row = e.target.closest('tr');
            const type = row.classList.contains('rep-based-form') ? 'rep-based' : 'timed';
            row.remove();
            updateFormIndices(type);
        }
    });

    // Form validation
    document.getElementById('workout-form').addEventListener('submit', function(e) {
        let isValid = true;

        // Validate rep-based exercises
        document.querySelectorAll('.rep-based-form').forEach(form => {
            const name = form.querySelector('input[name$="-name"]').value.trim();
            const sets = form.querySelector('input[name$="-sets"]').value;
            const reps = form.querySelector('input[name$="-reps"]').value;

            if (!name || !sets || !reps) {
                isValid = false;
            }
        });

        // Validate timed exercises
        document.querySelectorAll('.timed-form').forEach(form => {
            const name = form.querySelector('input[name$="-name"]').value.trim();
            const minutes = form.querySelector('input[name$="-duration_minutes"]').value;
            const seconds = form.querySelector('input[name$="-duration_seconds"]').value;

            if (!name || (!minutes && !seconds)) {
                isValid = false;
            }
        });

        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields for each exercise.');
        }
    });
});
</script>

<style>
    .rep-based-form .timed-field,
    .timed-form .rep-based-field {
        display: none;
    }

    .exercise-form .form-label {
        font-size: 0.8rem;
        margin-bottom: 0.2rem;
        color: #6c757d;
    }

    .exercise-form input {
        width: 100%;
    }

    .exercise-form td {
        min-width: 100px;
    }

    .exercise-form td:last-child {
        vertical-align: middle;
    }

    @media (max-width: 768px) {
        .table-responsive {
            overflow-x: auto;
        }
    }
</style>
{% endblock %}
{% endblock %}